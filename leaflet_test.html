<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Bus Route Selector</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>

<style>

#winning_panel { position: relative; display: flex; background-color: white; z-index: 5; justify-content: center; width: 25%; margin: 20px auto;}
   

#map { position: absolute; top: 0; bottom: 0; width: 100% ;z-index: 1; }
	
#search_drop_down_container {
  overflow: hidden;
  position: relative;
  display: flex;
  justify-content: center; /*centers items on the line (the x-axis by default)*/
  align-items: center; /*centers items on the cross-axis (y by default)*/
  z-index: 2; 
}

#search_drop_down {
    background-color:ghostwhite;
}


.box {
    position: relative;
    display: flex;
    justify-content: space-between;
    margin: 20px auto;
    top: 10%;
    width: 75%;
    height: 10%;
    z-index: 3;
    }
    .route_boxes {
    background-color: whitesmoke;
    z-index: 3;
    }
</style>

</head>
<body>
<div id="search_drop_down_container">
    <div id="search_drop_down">
        <label for="selected_route_dropdown" style="font-size:20px;">Guess a route:</label>
        <datalist class="legend" id="selected_route_dropdown" name="routes" placeholder="">
        </datalist>
        <input list="selected_route_dropdown" onChange="get_dropdown_data(this.value)"/> 
    </div>
</div>
<div id="winning_panel">
</div>

<div class="box">
    <div class="route_boxes" id="good_guesses_box">
        <h3>Good Guesses</h3>
        <p id="good_guesses_list">

        </p>
    </div>
    <div class="route_boxes" id="bad_guesses_box">
        <h3>Bad Guesses</h3>
        <p id="bad_guesses_list">

        </p>
    </div>
  </div>

<div id="map"></div> 

 
 
<script>

// I know this is wrong but I want to get the json object into a reusable variable...
var xhReq = new XMLHttpRequest();
xhReq.open("GET", "https://meysohn-sandbox.s3.amazonaws.com/trimet_trip_planner/itinerary_routes_long_name.geojson", false);
xhReq.send(null);
var itin_routes_long_name = JSON.parse(xhReq.responseText);

var xhReq = new XMLHttpRequest();
xhReq.open("GET", "https://meysohn-sandbox.s3.amazonaws.com/trimet_trip_planner/origin_destination_centriod.geojson", false);
xhReq.send(null);
var centroid_geojson = JSON.parse(xhReq.responseText);

var xhReq = new XMLHttpRequest();
xhReq.open("GET", "https://meysohn-sandbox.s3.amazonaws.com/trimet_trip_planner/itineraries_reduced_with_long_name.geojson", false);
xhReq.send(null);
var itineraries_reduced_geojson = JSON.parse(xhReq.responseText);

var itinerary_dict = {};
for (var i = 0; i < itineraries_reduced_geojson['features'].length; i++) {
    var one_row = itineraries_reduced_geojson['features'][i];
    // console.log(one_row);
    var itinerary_idx = one_row['properties']['itin_idx'];
    if (one_row['properties']['route_id']!='WALK') { 
        if (!(itinerary_idx in itinerary_dict)) {
            itinerary_dict[itinerary_idx] = [one_row['properties']['dropdown_route']]
        }
        else {
            itinerary_dict[itinerary_idx].push(one_row['properties']['dropdown_route'])
        }
    }
    else {
        // pass 'WALK' routes
    }
}

// console.log(itinerary_dict);



var good_routes = [];
for (var i = 0; i < itin_routes_long_name['features'].length; i++) {
        var one_route = itin_routes_long_name['features'][i];
        // console.log(one_route);
        var good_route_dd_name = one_route['properties'].dropdown_route;
        good_routes.push(good_route_dd_name)
        }

console.log(good_routes);


var dd_select = document.getElementById("selected_route_dropdown");

fetch("https://meysohn-sandbox.s3.amazonaws.com/trimet_trip_planner/gtfs_routes.json")
    .then(function (response){
        return response.json();
    })
    .then(function (data) {
        for(var i = 0; i < data.length; i++) {
        var opt = data[i];
        var el = document.createElement("option");
        el.textContent = opt.route_id + " - " + opt.route_long_name;
        el.value = opt.route_id + " - " + opt.route_long_name;
        dd_select.appendChild(el);
        }
    });


var selected_good_routes = [];
function get_dropdown_data(val){
    if (good_routes.includes(val)) {
  //  block of code to be executed if the condition is true
  var good_guesses = document.getElementById("good_guesses_list");
    var para_item = document.createElement("p");
    para_item.textContent = val;
    good_guesses.appendChild(para_item);
    selected_good_routes.push(val)
    //loop through the itineraries and see if the selected good routes have ALL the routes
    //if so - you WIN!
    for (const [key, value] of Object.entries(itinerary_dict)) {
    //   console.log(key, value);   
          if (value.every(r=> selected_good_routes.includes(r))) {
            var win_panel = document.getElementById("winning_panel");
            var header_item = document.createElement("h2");
            header_item.textContent = "You WIN!";
            win_panel.appendChild(header_item);
            console.log('you win! with routes: '+value);
            // console.log(value);
        }
        else {}
}
    fetch("https://meysohn-sandbox.s3.amazonaws.com/trimet_trip_planner/itinerary_routes_long_name.geojson")
    .then(function (response){
        return response.json();
    })
    .then(function (data) {
        
        L.geoJSON(data, {
            filter: function goodRouteFilter(feature) {
                if (feature.properties.dropdown_route === val) return true
            },
        style: styleRouteLines
    }).addTo(map);
    });
} else {
  //  block of code to be executed if the condition is false
  var bad_guesses = document.getElementById("bad_guesses_list");
    var para_item = document.createElement("p");
    para_item.textContent = val;
    bad_guesses.appendChild(para_item);
}
    
}

var map = L.map('map').setView([centroid_geojson['features'][0]['geometry']['coordinates'][1], centroid_geojson['features'][0]['geometry']['coordinates'][0]], 12);

L.tileLayer('https://stamen-tiles-a.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> | <a href="http://stamen.com">Stamen Design</a> | <a href="https://developer.trimet.org/gis/">TriMet</a>'
}).addTo(map);

var geojsonMarkerOptions = {
    radius: 8,
    fillColor: "red",
    color: "red",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
};


// label from https://gis.stackexchange.com/questions/245621/how-to-label-geojson-points-in-leaflet
fetch("https://meysohn-sandbox.s3.amazonaws.com/trimet_trip_planner/origin_destination_points.geojson")
    .then(function (response){
        return response.json();
    })
    .then(function (data) {
        L.geoJSON(data, {
        pointToLayer: function (feature, latlng) {
            label = String(feature.properties.point_type) // Must convert to string, .bindTooltip can't use straight 'feature.properties.attribute'
        return L.circleMarker(latlng, geojsonMarkerOptions).bindTooltip(label, {permanent: true, opacity: 0.7}).openTooltip();;
        }
    }).addTo(map);
    });

function styleRouteLines(feature) {
    return {
                color: feature.properties.route_color,
                weight: 4,
                opacity: .85
            };
}


</script>
 
</body>
</html>