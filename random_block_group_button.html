<!DOCTYPE html>
<html>
<head>
  <title>Random Point Selector</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>
<script src="gettrimettripplan.js"></script>
<script src="getnearbyroutes.js"></script>
<script src="decodePolyine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.0/leaflet.textpath.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js'></script>
  

  <style>
.route-button {
  margin: 5px;
  padding: 10px 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
  background-color: #f0f0f0;
  cursor: pointer;
}

  </style>
</head>
<body>
  <button id="generateButton">Generate Random Pair</button>
  <div id="map" style="width: 100%; height: 500px;"></div>
  <div id="buttonContainer-0" style="text-align: center;"></div>
  <div id="buttonContainer-1" style="text-align: center;"></div>
  <div id="buttonContainer-2" style="text-align: center;"></div>
  <div id="buttonContainer-3" style="text-align: center;"></div>

  <script>
    // Initialize the map
    var map = L.map('map').setView([45.52, -122.68], 12); 

        // Add a basemap (e.g., OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    


    // Load GeoJSON data from AWS S3
    fetch('https://meysohn-sandbox.s3.us-east-1.amazonaws.com/trimet_trip_planner/tm_route_buffer_blockgroup.geojson')
      .then(response => response.json())
      .then(data => {
        // Create a GeoJSON layer
        var geojsonLayer = L.geoJson(data).addTo(map);

        // Initialize markers as global variables
        let marker1, marker2, marker3;

        // Function to generate random pair of indices
        function generateRandomPair() {

          localStorage.clear(); // Clear local storage
          // Get the number of features
          var numFeatures = data.features.length;

          localStorage.removeItem("routeClicked")

          // Generate two unique random indices
          var index1 = Math.floor(Math.random() * numFeatures);
          var index2 = Math.floor(Math.random() * numFeatures);
          while (index2 === index1) {
            index2 = Math.floor(Math.random() * numFeatures);
          }

          // Clear existing styles
          geojsonLayer.resetStyle(); 

          // Style the selected features
          function highlightFeature(feature) {
            var selectedFeature = 
              feature === data.features[index1] || 
              feature === data.features[index2]; 
            return selectedFeature ? {
              weight: 5,
              color: '#666',
              dashArray: '',
              fillOpacity: 0.7
            } : {
              weight: 1,
              color: '#666',
              dashArray: '',
              fillOpacity: 0.1
            };
          }

          geojsonLayer.setStyle(highlightFeature);

          // Remove old markers from the map
          if (marker1) {
            map.removeLayer(marker1);
          }
          if (marker2) {
            map.removeLayer(marker2);
          }
          if (marker3) {
            map.removeLayer(marker2);
          }

          // Use turf.js to get a random point within each selected feature
          var point1 = turf.pointOnFeature(data.features[index1]);
          var point2 = turf.pointOnFeature(data.features[index2]);
          // console.log(point1);
          console.log(point1.geometry.coordinates);
          
          // Create markers at the random points
          marker1 = L.marker(point1.geometry.coordinates.reverse()).bindTooltip("Origin", { permanent: true, opacity: 0.7 })
          .openTooltip().addTo(map);
          
          marker2 = L.marker(point2.geometry.coordinates.reverse()).bindTooltip("Destination", { permanent: true, opacity: 0.7 })
          .openTooltip().addTo(map);

          let fromPlace = `${point1.geometry.coordinates[0]}, ${point1.geometry.coordinates[1]}`;
          let toPlace = `${point2.geometry.coordinates[0]}, ${point2.geometry.coordinates[1]}`;

          // Example usage
        // const fromPlace = "45.516194, -122.675840"; // Downtown Portland, OR
        // const toPlace = "45.562604, -122.682919"; // Killingsworth & Interstate MAX Station

        function showPolyline(legIndex) {
          polylines[legIndex].setStyle({ opacity: 1 }); // Show the polyline
        }

        function createRouteButtons(routeNumbersSet, legIndex) {
              // Iterate over the Set and create a button for each route
              routeNumbersSet.forEach(route => {
                // console.log(`creating button for route ${route} in legIndex ${legIndex}`);
            const button = document.createElement('button');
            button.textContent = `Route ${route}`;
            button.classList.add(`route-button-${legIndex}`);
            button.addEventListener('click', () => {
              console.log(`You clicked on a button`);
              const clickedRoute = button.textContent.split(" ")[1];
              const buttonclass = button.classList[0];
              winningRoute = localStorage.getItem(`winningRoute-${legIndex}`);

              if (`${clickedRoute}` === `${winningRoute}`) {
              console.log("you're in the winning route if statement");
            //show polyline
              showPolyline(legIndex)
            } 
              
            }); 
            buttonContainer = document.getElementById(`buttonContainer-${legIndex}`);
            buttonContainer.appendChild(button);
          });
          }

        // sourced from gettrimettripplan.js
        const trimetPlan = getTrimetPlan(fromPlace, toPlace);
        const polylines = []; 
        const itinerary = trimetPlan.plan.itineraries[0];
        const legs = itinerary.legs;
        const trimetLegs = legs.filter(leg => 
          leg.mode === 'BUS' || leg.mode === 'TRAM' || leg.mode === 'RAIL' || leg.mode === 'GONDOLA'
        );

        for (let legIndex = 0; legIndex < trimetLegs.length; legIndex++) {
          let winningRoute;
          console.log("in for loop");
          console.log(legIndex);
          console.log(`fromPlace ${fromPlace}`);
          winningRoute = trimetLegs[legIndex].routeId.split(":")[1];
          console.log(`winningRoute for legIndex ${legIndex} is ${winningRoute}`);
          localStorage.setItem(`winningRoute-${legIndex}`, winningRoute);
          trimetLeg = trimetLegs[legIndex];
          const decodedCoordinates = decodePolyline(trimetLeg.legGeometry.points);
          const polyline = L.polyline(decodedCoordinates, { color: 'red', opacity: 0}).addTo(map); // Add the polyline to the map
          polyline.index = legIndex; // Add the index to the polyline
          polylines.push(polyline); // Add the polyline to the polylines array
          const lastCoordinate = decodedCoordinates[decodedCoordinates.length - 1];
          fromPlace = lastCoordinate;
          console.log(`new FromPlace ${fromPlace}`);
          const routeNumbers = getNearbyRoutes(fromPlace);
          console.log(routeNumbers);
          console.log(`creating route buttons for legIndex ${legIndex}`);
          createRouteButtons(routeNumbers, legIndex);
        }
        

          // Zoom to fit the selected features
          var bounds = L.featureGroup([
            L.geoJson(data.features[index1]),
            L.geoJson(data.features[index2])
          ]).getBounds();
          map.fitBounds(bounds);

        }

        // Add event listener to the button
        document.getElementById('generateButton').addEventListener('click', generateRandomPair);
      });
  </script>
</body>
</html>